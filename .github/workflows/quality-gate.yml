name: Quality Gate

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main ]

jobs:
  coverage-verification:
    name: Test Coverage Verification
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Unit Tests
        run: ./gradlew --build-cache testDebugUnitTest

      - name: Architecture Boundary Guard
        run: ./scripts/boundary-guard.sh

      - name: ADR Required Check
        env:
          GIT_BASE_REF: ${{ github.base_ref }}
        run: ./scripts/check-adr.sh

      - name: Dependency Graph Report
        run: ./gradlew --build-cache projectDependencyReport

      - name: Upload Dependency Graph
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-graph
          path: build/reports/dependency-graph/

      - name: Check TODO/FIXME in code
        run: |
          if grep -R --line-number -E "TODO|FIXME" app core feature --include="*.kt" --include="*.kts"; then
            echo "TODO/FIXME found in code. Please move to backlog."
            exit 1
          fi

      - name: Run Instrumented Tests with Coverage
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: google_apis
          arch: x86_64
          profile: Nexus 6
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          script: ./gradlew --build-cache connectedDebugAndroidTest -Pcoverage

      - name: Generate Coverage Report
        run: ./gradlew --build-cache :app:jacocoTestReport

      - name: Verify Coverage Threshold (70%)
        run: ./gradlew --build-cache :app:jacocoTestCoverageVerification

      - name: Verify Core Coverage Thresholds (90%)
        run: ./gradlew --build-cache :core:domain:jacocoTestCoverageVerification :core:data:jacocoTestCoverageVerification

      - name: Comment Coverage on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const coverageFile = 'app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml';
            
            if (fs.existsSync(coverageFile)) {
              const coverage = fs.readFileSync(coverageFile, 'utf8');
              // Parse XML and extract coverage percentage
              const match = coverage.match(/counter type="LINE".*missed="(\d+)".*covered="(\d+)"/);
              
              if (match) {
                const missed = parseInt(match[1]);
                const covered = parseInt(match[2]);
                const total = missed + covered;
                const percentage = ((covered / total) * 100).toFixed(2);
                
                const comment = `## üìä Test Coverage Report\n\n` +
                  `**Line Coverage:** ${percentage}%\n` +
                  `- Covered: ${covered} lines\n` +
                  `- Missed: ${missed} lines\n` +
                  `- Total: ${total} lines\n\n` +
                  (percentage >= 70 ? '‚úÖ Coverage threshold met!' : '‚ö†Ô∏è Coverage below 70% threshold');
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            }

  code-quality:
    name: Code Quality Metrics
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Detekt
        run: ./gradlew --build-cache detekt

      - name: Check Detekt Results
        run: |
          if [ -f build/reports/detekt/detekt.xml ]; then
            ISSUES=$(grep -c '<error' build/reports/detekt/detekt.xml || echo 0)
            echo "üîç Detekt found $ISSUES issues"
            
            if [ $ISSUES -gt 0 ]; then
              echo "‚ö†Ô∏è Code quality issues detected"
              exit 1
            else
              echo "‚úÖ No code quality issues found"
            fi
          fi

  build-time-check:
    name: Build Performance Check
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Clean Build with Timing
        run: |
          START_TIME=$(date +%s)
          ./gradlew --build-cache clean assembleFreeDebug --profile
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - START_TIME))
          
          echo "‚è±Ô∏è Build completed in ${BUILD_TIME} seconds"
          
          # Build time budget: 10 minutes (600 seconds) - ENFORCED
          if [ $BUILD_TIME -gt 600 ]; then
            echo "‚ùå Build time exceeded 10-minute budget - Build FAILED"
            echo "::error::Build took ${BUILD_TIME}s (budget: 600s)"
            exit 1
          else
            echo "‚úÖ Build time within budget"
          fi

      - name: Upload Build Profile
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: build-profile
          path: build/reports/profile/

  apk-analysis:
    name: APK Size Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Release APK
        run: ./gradlew --build-cache assembleFreeRelease

      - name: Analyze APK Size
        run: |
          APK_FILE=$(find app/build/outputs/apk/free/release -name "*.apk" | head -n 1)
          
          if [ -f "$APK_FILE" ]; then
            APK_SIZE=$(stat -f%z "$APK_FILE" 2>/dev/null || stat -c%s "$APK_FILE")
            APK_SIZE_MB=$((APK_SIZE / 1024 / 1024))
            
            echo "üì¶ APK Size: ${APK_SIZE_MB} MB"
            
            # APK size budget: 15 MB (ENFORCED)
            if (( $(echo "$APK_SIZE_MB > 15" | bc -l) )); then
              echo "‚ùå APK size exceeds 15 MB budget - Build FAILED"
              echo "::error::APK size is ${APK_SIZE_MB}MB (budget: 15MB)"
              exit 1
            else
              echo "‚úÖ APK size within budget"
            fi
          fi

  security-check:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'MyNewApp'
          path: '.'
          format: 'HTML'
          args: >
            --failOnCVSS 7
            --enableRetired

      - name: Upload Dependency Check Report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: dependency-check-report
          path: reports/

      - name: Check for Secrets
        run: |
          echo "\u003e\u003e Scanning for exposed secrets..."

          # Check for common secret patterns
          if grep -r "api_key\|API_KEY\|password\|secret" --include="*.kt" --include="*.xml" app/src/main 2>/dev/null | grep -v "BuildConfig" | grep -v "strings.xml"; then
            echo "FAIL: Potential secrets found in source code"
            exit 1
          else
            echo "OK: No obvious secrets detected"
          fi

          # google-services.json must stay local and untracked
          if find . -name "google-services.json" -not -path "./.git/*" | grep -q "google-services.json"; then
            echo "FAIL: google-services.json detected in the repository"
            exit 1
          else
            echo "OK: google-services.json not present"
          fi
