#!/bin/sh
# Pre-commit hook for Android project
# Senior Level Best Practice: Automated quality checks before commit

echo "ðŸ” Running pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check for staged Kotlin files
STAGED_KOTLIN_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.kt$')

if [ -z "$STAGED_KOTLIN_FILES" ]; then
    echo "${GREEN}âœ… No Kotlin files to check${NC}"
    exit 0
fi

echo "ðŸ“ Checking ${#STAGED_KOTLIN_FILES[@]} Kotlin file(s)..."

# 1. Run Detekt on staged files
echo "\nðŸ”¬ Running Detekt static analysis..."
./gradlew detekt --daemon -q

if [ $? -ne 0 ]; then
    echo "${RED}âŒ Detekt found issues. Please fix them before committing.${NC}"
    echo "${YELLOW}Run './gradlew detekt' to see full report.${NC}"
    exit 1
fi

echo "${GREEN}âœ… Detekt passed${NC}"

# 2. Run unit tests
echo "\nðŸ§ª Running unit tests..."
./gradlew testDebugUnitTest --daemon -q

if [ $? -ne 0 ]; then
    echo "${RED}âŒ Unit tests failed. Please fix them before committing.${NC}"
    exit 1
fi

echo "${GREEN}âœ… Unit tests passed${NC}"

# 3. Check for TODO/FIXME in staged files (warning only)
echo "\nðŸ“‹ Checking for TODO/FIXME comments..."
TODO_COUNT=$(echo "$STAGED_KOTLIN_FILES" | xargs grep -l "TODO\|FIXME" 2>/dev/null | wc -l)

if [ "$TODO_COUNT" -gt 0 ]; then
    echo "${YELLOW}âš ï¸  Found $TODO_COUNT file(s) with TODO/FIXME comments${NC}"
    echo "$STAGED_KOTLIN_FILES" | xargs grep -n "TODO\|FIXME" 2>/dev/null
    echo "${YELLOW}Consider resolving these before release.${NC}"
fi

# 4. Check for debug statements
echo "\nðŸ› Checking for debug statements..."
DEBUG_PATTERNS="println\|System\.out\|Log\.d\|Log\.v"
DEBUG_COUNT=$(echo "$STAGED_KOTLIN_FILES" | xargs grep -l "$DEBUG_PATTERNS" 2>/dev/null | wc -l)

if [ "$DEBUG_COUNT" -gt 0 ]; then
    echo "${YELLOW}âš ï¸  Found potential debug statements in $DEBUG_COUNT file(s)${NC}"
    echo "$STAGED_KOTLIN_FILES" | xargs grep -n "$DEBUG_PATTERNS" 2>/dev/null
fi

echo "\n${GREEN}âœ… All pre-commit checks passed!${NC}"
exit 0

